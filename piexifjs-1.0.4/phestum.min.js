var system=require("system");var fs=require("fs");var phestumLib=function(){}.toString().match(/\/\*([^]*)\*\//)[1];eval(phestumLib);if(fs.isDirectory("tests/files")){Tests._files={};var optionFiles=fs.list("tests/files/").filter(function(item){return[".",".."].indexOf(item)==-1});console.log("files: "+JSON.stringify(optionFiles));for(var p=0;p<optionFiles.length;p++){Tests._files[optionFiles[p]]=fs.read("tests/files/"+optionFiles[p],{charset:"LATIN-1"})}}Tests._libs=[];if(system.args.length>1){Tests._libs=system.args.slice(1);console.log("lib: "+JSON.stringify(Tests._libs))}Tests._tests=fs.list("tests/").filter(function(item){return item.indexOf(".js")!==-1}).map(function(item){return"tests/"+item});var jsScripts=Tests._libs.concat(Tests._tests);var page=require("webpage").create();page.onError=function(msg,trace){var msgStack=["ERROR: "+msg];if(trace&&trace.length){msgStack.push("**TRACE:");trace.forEach(function(t){msgStack.push(" -> "+t.file+": "+t.line+(t.function?' (in function "'+t.function+'")':""))})}console.error("**"+msgStack.join("\n"))};page.onConsoleMessage=function(msg,lineNum,sourceId){if(msg=="finished phestum tests."){var conc=page.evaluate(function(){return Tests.conc});console.log("\n\nPassed: "+conc.pass);console.log("Failed: "+conc.fail);if(conc.fail){setTimeout(function(){phantom.exit(1)},0)}else{setTimeout(function(){phantom.exit()},0)}}else{console.log(""+msg)}};page.evaluate(function(script){var scrEl=document.createElement("script");scrEl.text=script;document.body.appendChild(scrEl)},phestumLib);for(var p=0;p<jsScripts.length;p++){page.injectJs(jsScripts[p])}page.evaluate(function(files){Tests.files=files},Tests._files);page.evaluate(function(){Tests._testNames=Object.keys(Tests).filter(function(item){return item[0]!=="_"&&typeof Tests[item]==="function"&&item.indexOf("Test")>-1});console.log("test: "+JSON.stringify(Tests._testNames));var tests={};for(var p=0;p<Tests._testNames.length;p++){(function(){var test;var testName=Tests._testNames[p];if(testName.indexOf("Async")==-1){test=function(){var gotError=false;try{Tests[testName]()}catch(e){console.log(e);if("stack"in e){console.log(e["stack"].split("at phantomjs://webpage.evaluate()")[0])}gotError=true}return gotError}}else{test=function(){try{Tests[testName](function(){Tests["_"+testName]=1},function(sec){Tests["__"+testName]=sec*1e3})}catch(e){console.log(e);if("stack"in e){console.log(e["stack"].split("at phantomjs://webpage.evaluate()")[0])}}}}tests[testName]=test})()}function recurTests(tests){if(Object.keys(tests).length==0){console.log("finished phestum tests.");return}var testName=Object.keys(tests)[0];var test=tests[testName];delete tests[testName];console.log("\n\n"+testName);console.log("=============");var gotError=test();if(testName.indexOf("Async")==-1){console.log("=============");if(gotError){Tests.conc.fail+=1;console.log("fail")}else{Tests.conc.pass+=1;console.log("pass")}recurTests(tests)}else{var secToWait=Tests["__"+testName]||1e3;setTimeout(function(){console.log("=============");if(Tests["_"+testName]==1){Tests.conc.pass+=1;console.log("pass")}else{console.log("Couldn't catch test finish.");Tests.conc.fail+=1;console.log("fail")}recurTests(tests)},secToWait)}}recurTests(tests)});